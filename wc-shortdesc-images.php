<?php

/*ğŸ“„ Ø¯Ø§Ú©ÛŒÙˆÙ…Ù†Øª ÙÙ†ÛŒ (Documentation)
Ø¹Ù†ÙˆØ§Ù† Ù¾Ø±ÙˆÚ˜Ù‡: Ø§Ø¨Ø²Ø§Ø± Ø§Ù†ØªÙ‚Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØµØ§ÙˆÛŒØ± ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©ÙˆØªØ§Ù‡ Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ ÙˆÙˆÚ©Ø§Ù…Ø±Ø³
Ù…Ø³ÛŒØ± Ø¯Ø³ØªØ±Ø³ÛŒ (Route): https://noraste.com/wp-admin/admin.php?page=shortdesc_gallery_tool

Û±. ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ù„ÛŒ
Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª ÛŒÚ© Ø§Ø¨Ø²Ø§Ø± Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¯Ø± Ù¾ÛŒØ´Ø®ÙˆØ§Ù† ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ ÙˆØ¸ÛŒÙÙ‡ Ø¢Ù† Ø¨Ø±Ø±Ø³ÛŒ Â«ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©ÙˆØªØ§Ù‡Â» (Short Description) Ù…Ø­ØµÙˆÙ„Ø§Øª ÙˆÙˆÚ©Ø§Ù…Ø±Ø³ Ø§Ø³Øª. Ø§Ú¯Ø± ØªØµÙˆÛŒØ±ÛŒ Ø¯Ø± Ù…ØªÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª ÛŒØ§ÙØª Ø´ÙˆØ¯ Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Â«Ú¯Ø§Ù„Ø±ÛŒ ØªØµØ§ÙˆÛŒØ±Â» Ù…Ø­ØµÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¢Ù† ØªØµÙˆÛŒØ± Ø±Ø§ Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ Ù…Ø­ØµÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

Û². ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§
Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ (UI): ÛŒÚ© ØµÙØ­Ù‡ Ù…Ø¯Ø±Ù† Ùˆ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ (Responsive) Ø¨Ø§ Ø§Ø³ØªØ§ÛŒÙ„â€ŒØ¯Ù‡ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ.
Ø­Ø§Ù„Øª ØªØ³Øª (Single Test): Ø§Ù…Ú©Ø§Ù† ØªØ³Øª Ø±ÙˆÛŒ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø®Ø§Øµ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ID: 7023) Ø¬Ù‡Øª Ø¨Ø±Ø±Ø³ÛŒ ØµØ­Øª Ø¹Ù…Ù„Ú©Ø±Ø¯.
Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ù†Ø¨ÙˆÙ‡ (Bulk Process): Ù‚Ø§Ø¨Ù„ÛŒØª Ø§Ø¬Ø±Ø§ Ø±ÙˆÛŒ ØªÙ…Ø§Ù…ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø¨Ø§ Ù„ØºÙˆ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ Ø³Ø±ÙˆØ± (set_time_limit(0)) Ùˆ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø´.
Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡ÛŒ (Logging): Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø§Ø² Ø¹Ù…Ù„ÛŒØ§ØªØŒ Ø´Ø§Ù…Ù„ ØªØ¹Ø¯Ø§Ø¯ ØªØµØ§ÙˆÛŒØ± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ùˆ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡.
Ù‡ÙˆØ´Ù…Ù†Ø¯ÛŒ Ø¯Ø± ÛŒØ§ÙØªÙ†: Ø¬Ø³ØªØ¬ÙˆÛŒ ØªØµØ§ÙˆÛŒØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… ÙØ§ÛŒÙ„ (Filename) Ø¨Ù‡ Ø¬Ø§ÛŒ URL Ú©Ø§Ù…Ù„ Ú©Ù‡ Ø¨Ø§Ø¹Ø« Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¨Ø§Ù„Ø§ØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Û³. Ù†Ø­ÙˆÙ‡ Ù†ØµØ¨ Ùˆ Ø§Ø¬Ø±Ø§
Ú©Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ functions.php Ù‚Ø§Ù„Ø¨ ÙØ±Ø²Ù†Ø¯ (Child Theme) ÛŒØ§ Ø¯Ø± ÛŒÚ© Ù¾Ù„Ø§Ú¯ÛŒÙ† Ø§Ø®ØªØµØ§ØµÛŒ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.
ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ´Ø®ÙˆØ§Ù† ÙˆØ±Ø¯Ù¾Ø±Ø³ Ø´ÙˆÛŒØ¯.
Ø¢Ø¯Ø±Ø³ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:
https://noraste.com/wp-admin/admin.php?page=shortdesc_gallery_tool
ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
Û´. Ù†Ú©Ø§Øª ÙÙ†ÛŒ
Ø§Ù…Ù†ÛŒØª: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Nonce Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¹Ù„ÛŒ (CSRF) Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ manage_options.
Ù¾Ø±ÙÙˆØ±Ù…Ù†Ø³: Ø¯Ø± Ø­Ø§Ù„Øª "Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª"ØŒ Ø§Ø² ØªØ§Ø¨Ø¹ wp_suspend_cache_invalidation(true) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ ØªØ§ Ø³Ø±Ø¹Øª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø§Ù„Ø§ Ø¨Ø±ÙˆØ¯.
Ø±ÛŒÙØ±Ø´ ØµÙØ­Ù‡: Ù¾Ø³ Ø§Ø² Ø²Ø¯Ù† Ø¯Ú©Ù…Ù‡ØŒ ØµÙØ­Ù‡ Ø±ÙØ±Ø´ Ø´Ø¯Ù‡ Ùˆ Ù†ØªÛŒØ¬Ù‡ Ø¯Ø± Ú©Ø§Ø¯Ø± "Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„ÛŒØ§Øª" Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ù…Ø´Ú©Ù„ ØµÙØ­Ù‡ Ø³ÙÛŒØ¯ Ù‚Ø¨Ù„ÛŒ Ø±ÙØ¹ Ø´Ø¯Ù‡ Ø§Ø³Øª).

*/

add_action('admin_post_test_shortdesc_images_6945', function () {

/**
 * 
 Rute : https://noraste.com/wp-admin/admin.php?page=shortdesc_gallery_tool
Ø§ÙØ²ÙˆØ¯Ù† Ù…Ù†Ùˆ Ø¨Ù‡ Ù¾ÛŒØ´Ø®ÙˆØ§Ù† ÙˆØ±Ø¯Ù¾Ø±Ø³
 */
add_action('admin_menu', 'sd_add_admin_menu');
function sd_add_admin_menu() {
    add_submenu_page(
        null, // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø§Ø² Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
        'Ø§Ù†ØªÙ‚Ø§Ù„ ØªØµØ§ÙˆÛŒØ± ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ',
        'Ø§Ù†ØªÙ‚Ø§Ù„ ØªØµØ§ÙˆÛŒØ± ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ',
        'manage_options',
        'shortdesc_gallery_tool',
        'sd_render_admin_page'
    );
}

/**
 * Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø§Ø¨Ø²Ø§Ø± Ùˆ Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† ÙØ±Ù…
 */
function sd_render_admin_page() {
    
    // Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø®Ø±ÙˆØ¬ÛŒ Ù„Ø§Ú¯
    $log_output = '';
    $has_error = false;
    $show_log = false;

    // -------------------------------------------------------------
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙØ±Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±
    // -------------------------------------------------------------
    if (isset($_POST['sd_action']) && isset($_POST['sd_nonce'])) {
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ
        if (!wp_verify_nonce($_POST['sd_nonce'], 'sd_process_action')) {
            wp_die('Ø®Ø·Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: Nonce Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.');
        }

        if (!current_user_can('manage_options')) {
            wp_die('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²');
        }

        $action = sanitize_text_field($_POST['sd_action']);
        $product_ids = [];

        // ---------------- Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª ----------------

        // Ø­Ø§Ù„Øª 1: ØªØ³Øª Ø±ÙˆÛŒ ÛŒÚ© Ù…Ø­ØµÙˆÙ„ Ø®Ø§Øµ (ID 7023)
        if ($action === 'single') {
            $product_ids = [7023]; 
        }
        // Ø­Ø§Ù„Øª 2: Ø§Ø¬Ø±Ø§ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª
        elseif ($action === 'all') {
            // Ø§ÙØ²Ø§ÛŒØ´ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§
            set_time_limit(0);
            ignore_user_abort(true); 
            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø´ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
            wp_suspend_cache_invalidation(true);

            $args = [
                'post_type'      => 'product',
                'posts_per_page' => -1, 
                'fields'         => 'ids', 
                'post_status'    => 'publish',
            ];
            $product_ids = get_posts($args);
        }

        // ---------------- Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ Ú¯Ø±ÙØªÙ† Ù„Ø§Ú¯ ----------------
        if (!empty($product_ids)) {
            ob_start(); // Ø´Ø±ÙˆØ¹ Ø°Ø®ÛŒØ±Ù‡ Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡
            sd_process_products($product_ids);
            $log_output = ob_get_clean(); // Ú¯Ø±ÙØªÙ† Ø®Ø±ÙˆØ¬ÛŒ Ùˆ Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù†
            $show_log = true;
        }
    }

    ?>
    <!-- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ -->
    <style>
        .sd-wrapper {
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-family: Tahoma, sans-serif;
            direction: rtl;
            text-align: right;
        }
        .sd-header h1 {
            margin-top: 0;
            color: #2271b1;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        .sd-card {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .sd-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .sd-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .sd-btn-primary {
            background-color: #2271b1;
            color: #fff;
        }
        .sd-btn-primary:hover {
            background-color: #135e96;
        }
        .sd-btn-danger {
            background-color: #d63638;
            color: #fff;
        }
        .sd-btn-danger:hover {
            background-color: #b32d2e;
        }
        .sd-log {
            margin-top: 30px;
            padding: 20px;
            background: #f6f7f7;
            border: 1px solid #ccd0d4;
            border-radius: 4px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            display: none; /* Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø®ÙÛŒ */
        }
        .success { color: #00a32a; font-weight: bold; }
        .error { color: #d63638; font-weight: bold; }
        .warning { color: #dba617; }
    </style>

    <div class="sd-wrapper">
        <div class="sd-header">
            <h1>ğŸ› ï¸ Ø§Ø¨Ø²Ø§Ø± Ø§Ù†ØªÙ‚Ø§Ù„ ØªØµØ§ÙˆÛŒØ± Ø¨Ù‡ Ú¯Ø§Ù„Ø±ÛŒ Ù…Ø­ØµÙˆÙ„</h1>
            <p>Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± ØªØµØ§ÙˆÛŒØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Â«ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©ÙˆØªØ§Ù‡Â» Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ø±Ø¯Ù‡ Ùˆ Ø§Ú¯Ø± Ø¯Ø± Ú¯Ø§Ù„Ø±ÛŒ Ù†Ø¨Ø§Ø´Ù†Ø¯ØŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</p>
        </div>

        <div class="sd-card">
            <h3>ğŸ“‹ ÙˆØ¶Ø¹ÛŒØª Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª:</h3>
            <p>Ù„Ø·ÙØ§Ù‹ ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
            
            <form id="sdForm" method="post">
                <?php wp_nonce_field('sd_process_action', 'sd_nonce'); ?>
                
                <div class="sd-actions">
                    <!-- Ø¯Ú©Ù…Ù‡ Ø§Ø¬Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª -->
                    <button type="submit" name="sd_action" value="all" class="sd-btn sd-btn-primary" onclick="return confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø¨Ø§Ø´Ø¯.')">
                        ğŸš€ Ø§Ø¬Ø±Ø§ Ø±ÙˆÛŒ Ù‡Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª
                    </button>

                    <!-- Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ø±ÙˆÛŒ ÛŒÚ© Ø¢ÛŒØ¯ÛŒ Ø®Ø§Øµ -->
                    <button type="submit" name="sd_action" value="single" class="sd-btn sd-btn-danger">
                        ğŸ§ª ØªØ³Øª Ø±ÙˆÛŒ Ù…Ø­ØµÙˆÙ„ ID: 7023
                    </button>
                </div>
            </form>
            
            <p style="margin-top:15px; font-size:12px; color:#666;">
                Ù†Ú©ØªÙ‡: Ù¾Ø³ Ø§Ø² Ú©Ù„ÛŒÚ©ØŒ ØµÙØ­Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø±ÙØ±Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù†ØªÛŒØ¬Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ø¯Ø± Ú©Ø§Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </p>
        </div>

        <!-- Ø¨Ø®Ø´ Ù„Ø§Ú¯ Ø®Ø±ÙˆØ¬ÛŒ -->
        <!-- Ø§Ú¯Ø± Ù…ØªØºÛŒØ± show_log true Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§Ú©Ø³ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡ -->
        <div id="logOutput" class="sd-log" <?php echo $show_log ? 'style="display:block;"' : ''; ?>>
            <?php echo $log_output; ?>
        </div>
    </div>
    <?php
}

/**
 * ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø­ØµÙˆÙ„Ø§Øª (Ù…Ù†Ø·Ù‚ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§)
 */
function sd_process_products($product_ids) {
    echo '<div style="direction: rtl; font-family: Tahoma, sans-serif;">';
    echo '<h3>Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„ÛŒØ§Øª:</h3><hr>';

    $counter = 0;

    foreach ($product_ids as $product_id) {
        $product = wc_get_product($product_id);

        if (!$product) {
            echo "<span class='error'>âŒ Ù…Ø­ØµÙˆÙ„ ID $product_id Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</span><br>";
            continue;
        }

        $short_desc = $product->get_short_description();
        if (empty($short_desc)) {
            // Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ…ÛŒØ²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
            continue;
        }

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªØµØ§ÙˆÛŒØ± Ø¯Ø± Ù…ØªÙ†
        preg_match_all('/<img[^>]+src="([^"]+)"/i', $short_desc, $matches);
        if (empty($matches[1])) {
            continue;
        }

        $gallery = $product->get_gallery_image_ids();
        $added = [];
        $not_found = [];

        foreach ($matches[1] as $img_url) {
            $filename = basename(parse_url($img_url, PHP_URL_PATH));

            // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª allowed_images
            $attachment = get_posts([
                'post_type'      => 'attachment',
                'name'           => sanitize_title(pathinfo($filename, PATHINFO_FILENAME)),
                'posts_per_page' => 1,
                'post_status'    => 'inherit',
                'suppress_filters' => false,
            ]);

            if (!$attachment) {
                $not_found[] = $filename;
                continue;
            }

            $att_id = $attachment[0]->ID;

            if (!in_array($att_id, $gallery)) {
                $gallery[] = $att_id;
                $added[] = $filename;
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
        if (!empty($added)) {
            $product->set_gallery_image_ids($gallery);
            $product->save();
            echo "<span class='success'>âœ… Ù…Ø­ØµÙˆÙ„ ID $product_id:</span> " . count($added) . " ØªØµÙˆÛŒØ± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.<br>";
            $counter++;
        }
        
        // Ù„Ø§Ú¯ Ø®Ø·Ø§Ù‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        /*
        if (!empty($not_found)) {
            echo "<span class='error'>âš ï¸ Ù…Ø­ØµÙˆÙ„ ID $product_id:</span> " . count($not_found) . " ØªØµÙˆÛŒØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.<br>";
        }
        */
    }

    echo '<hr>';
    echo "<strong>Ù¾Ø§ÛŒØ§Ù† Ø¹Ù…Ù„ÛŒØ§Øª. ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡: $counter</strong>";
    echo '</div>';
}
?>